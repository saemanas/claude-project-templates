name: Weekly Memory Report

on:
  schedule:
    # Run every Friday at 18:00 UTC
    - cron: '0 18 * * 5'
  workflow_dispatch:  # Manual trigger

jobs:
  report:
    name: Generate Weekly Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for stats

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install tiktoken

      - name: Generate memory statistics
        id: stats
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime
          from pathlib import Path

          stats = {
              "generated": datetime.now().isoformat(),
              "files": {},
              "totals": {
                  "memory_files": 0,
                  "doc_files": 0,
                  "decisions": 0,
                  "weekly_logs": 0,
              }
          }

          # Count files
          memory_path = Path("memory")
          docs_path = Path("docs")

          if memory_path.exists():
              stats["totals"]["memory_files"] = len(list(memory_path.rglob("*.md")))
              stats["totals"]["decisions"] = len(list((memory_path / "decisions").glob("DEC-*.md"))) if (memory_path / "decisions").exists() else 0
              stats["totals"]["weekly_logs"] = len(list((memory_path / "timeline").glob("????-W??.md"))) if (memory_path / "timeline").exists() else 0

          if docs_path.exists():
              stats["totals"]["doc_files"] = len(list(docs_path.rglob("*.md")))

          # Check line counts for core files
          core_files = {
              "memory/NOW.md": 300,
              "memory/FIND.md": 200,
              "memory/decisions/INDEX.md": 300,
          }

          for file, limit in core_files.items():
              path = Path(file)
              if path.exists():
                  lines = len(path.read_text().splitlines())
                  stats["files"][file] = {
                      "lines": lines,
                      "limit": limit,
                      "usage_percent": round(lines / limit * 100, 1)
                  }

          print(json.dumps(stats, indent=2))

          # Save for later steps
          with open("memory_stats.json", "w") as f:
              json.dump(stats, f, indent=2)
          EOF

      - name: Generate token report
        run: |
          python3 scripts/count-tokens.py --report > token_report.txt 2>&1 || true

      - name: Get git activity
        id: git-stats
        run: |
          echo "## Git Activity (Last 7 days)" > git_activity.txt
          echo "" >> git_activity.txt

          # Commits to memory/
          echo "### Memory Changes" >> git_activity.txt
          git log --oneline --since="7 days ago" -- memory/ | head -20 >> git_activity.txt || echo "No changes" >> git_activity.txt

          echo "" >> git_activity.txt

          # Commits to docs/
          echo "### Documentation Changes" >> git_activity.txt
          git log --oneline --since="7 days ago" -- docs/ | head -20 >> git_activity.txt || echo "No changes" >> git_activity.txt

      - name: Create summary report
        run: |
          echo "# Weekly Memory System Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## File Statistics" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat memory_stats.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Token Usage" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -30 token_report.txt >> $GITHUB_STEP_SUMMARY || echo "No report available" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          cat git_activity.txt >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Weekly Report workflow*" >> $GITHUB_STEP_SUMMARY

      - name: Check for issues
        run: |
          python3 << 'EOF'
          import json
          import sys

          with open("memory_stats.json") as f:
              stats = json.load(f)

          issues = []

          for file, data in stats.get("files", {}).items():
              if data.get("usage_percent", 0) > 90:
                  issues.append(f"{file} is {data['usage_percent']}% full")

          if issues:
              print("::warning::Memory system issues found:")
              for issue in issues:
                  print(f"::warning::{issue}")
          else:
              print("No issues found")
          EOF
