name: Auto Archive Old Logs

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  archive:
    name: Archive Old Memory Logs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Archive old weekly logs
        id: archive
        run: |
          python3 << 'EOF'
          import os
          import re
          import shutil
          from datetime import datetime, timedelta
          from pathlib import Path

          ARCHIVE_AFTER_WEEKS = 12  # Archive logs older than 12 weeks
          TIMELINE_DIR = Path("memory/timeline")
          ARCHIVE_DIR = Path("memory/archive")

          def get_week_date(filename):
              """Extract date from YYYY-Wnn.md filename."""
              match = re.match(r'(\d{4})-W(\d{2})\.md$', filename)
              if match:
                  year, week = int(match.group(1)), int(match.group(2))
                  # Get first day of that week
                  return datetime.strptime(f'{year}-W{week}-1', '%G-W%V-%u')
              return None

          def get_quarter(date):
              """Get quarter string from date."""
              quarter = (date.month - 1) // 3 + 1
              return f"{date.year}-Q{quarter}"

          def main():
              if not TIMELINE_DIR.exists():
                  print("No timeline directory found")
                  return

              cutoff_date = datetime.now() - timedelta(weeks=ARCHIVE_AFTER_WEEKS)
              files_to_archive = []
              archived_count = 0

              # Find old weekly logs
              for file in TIMELINE_DIR.glob("????-W??.md"):
                  week_date = get_week_date(file.name)
                  if week_date and week_date < cutoff_date:
                      files_to_archive.append((file, week_date))

              if not files_to_archive:
                  print("No files to archive")
                  return

              # Archive files by quarter
              for file, week_date in files_to_archive:
                  quarter = get_quarter(week_date)
                  quarter_dir = ARCHIVE_DIR / quarter

                  quarter_dir.mkdir(parents=True, exist_ok=True)

                  dest = quarter_dir / file.name
                  print(f"Archiving: {file} -> {dest}")
                  shutil.move(str(file), str(dest))
                  archived_count += 1

              print(f"\nArchived {archived_count} file(s)")

              # Set output for GitHub Actions
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write(f"archived_count={archived_count}\n")

          if __name__ == "__main__":
              main()
          EOF

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Auto-archive old memory logs"
          title: "Auto-archive old memory logs"
          body: |
            ## Automated Archive

            This PR was automatically created to archive old weekly logs (>12 weeks old).

            ### What's archived
            - Weekly logs older than 12 weeks moved to `memory/archive/YYYY-Qn/`

            ### Review
            - [ ] Verify archived files are correct
            - [ ] Check that no important recent logs were archived

            ---
            *Generated by Auto Archive workflow*
          branch: auto-archive
          delete-branch: true
          labels: |
            automated
            maintenance

      - name: Summary
        run: |
          echo "## Auto Archive Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "Files archived. Pull request created." >> $GITHUB_STEP_SUMMARY
          else
            echo "No files to archive this week." >> $GITHUB_STEP_SUMMARY
          fi
