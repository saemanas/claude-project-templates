#!/bin/bash
#
# commit-msg hook - Enforce detailed, human-readable commit messages
#
# All commits must follow this format for human developers to understand:
#
# <type>: <short description>
#
# ## What
# <detailed description of what was done>
#
# ## Why
# <reason for the change>
#
# ## Files Changed
# - file1.ext: description
# - file2.ext: description
#

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

ERRORS=0

echo ""
echo "══════════════════════════════════════════════════════════════"
echo "  Commit Message Validation"
echo "══════════════════════════════════════════════════════════════"
echo ""

# 1. Check first line format: <type>: <description>
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)

if ! echo "$FIRST_LINE" | grep -qE "^(feat|fix|hotfix|docs|refactor|test|chore|style|perf|ci|build|revert)(\(.+\))?: .+"; then
    echo -e "${RED}[ERROR]${NC} First line must be: <type>: <description>"
    echo ""
    echo "  Valid types:"
    echo "    feat     - New feature"
    echo "    fix      - Bug fix"
    echo "    hotfix   - Urgent production fix"
    echo "    docs     - Documentation only"
    echo "    refactor - Code refactoring"
    echo "    test     - Adding tests"
    echo "    chore    - Maintenance"
    echo "    style    - Formatting"
    echo "    perf     - Performance"
    echo "    ci       - CI/CD changes"
    echo "    build    - Build system"
    echo "    revert   - Revert previous commit"
    echo ""
    echo "  Example: feat: add user authentication"
    echo ""
    ((ERRORS++))
fi

# 2. Check minimum message length (should have details)
MSG_LENGTH=$(echo "$COMMIT_MSG" | wc -c | tr -d ' ')
if [[ $MSG_LENGTH -lt 100 ]]; then
    echo -e "${YELLOW}[WARN]${NC} Commit message is too short ($MSG_LENGTH chars)"
    echo ""
    echo "  Good commit messages should include:"
    echo "    - What was changed"
    echo "    - Why it was changed"
    echo "    - Which files were affected"
    echo ""
fi

# 3. Check for ## What section (recommended)
if ! echo "$COMMIT_MSG" | grep -qE "^## What|^What:|^\*\*What\*\*"; then
    echo -e "${YELLOW}[WARN]${NC} Missing 'What' section"
    echo "  Consider adding: ## What"
    echo ""
fi

# 4. Check for ## Why section (recommended)
if ! echo "$COMMIT_MSG" | grep -qE "^## Why|^Why:|^\*\*Why\*\*"; then
    echo -e "${YELLOW}[WARN]${NC} Missing 'Why' section"
    echo "  Consider adding: ## Why"
    echo ""
fi

# 5. If decision file is being committed, check reference
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null)

if echo "$STAGED_FILES" | grep -qE "memory/decisions/DEC-[0-9]+"; then
    DEC_ID=$(echo "$STAGED_FILES" | grep -oE "DEC-[0-9]+" | head -1)

    if ! echo "$COMMIT_MSG" | grep -q "$DEC_ID"; then
        echo -e "${RED}[ERROR]${NC} Decision file committed without reference"
        echo "  Add '$DEC_ID' to your commit message"
        echo ""
        ((ERRORS++))
    fi
fi

# 6. Check for memory update when code changes
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(py|js|ts|jsx|tsx|go|rs|java|c|cpp|h|hpp|rb|php|swift|kt|scala|cs)$' | wc -l | tr -d ' ')
MEMORY_FILES=$(echo "$STAGED_FILES" | grep -E '^memory/' | wc -l | tr -d ' ')

if [[ $CODE_FILES -gt 0 ]] && [[ $MEMORY_FILES -eq 0 ]]; then
    echo -e "${YELLOW}[WARN]${NC} Code changed without memory update"
    echo "  Consider updating:"
    echo "    - memory/timeline/$(date +%Y-W%V).md"
    echo "    - memory/NOW.md (if status changed)"
    echo ""
fi

# Summary
if [[ $ERRORS -gt 0 ]]; then
    echo "──────────────────────────────────────────────────────────────"
    echo -e "${RED}COMMIT BLOCKED: $ERRORS error(s)${NC}"
    echo ""
    echo "Example of a good commit message:"
    echo ""
    echo "  feat: add user authentication system"
    echo ""
    echo "  ## What"
    echo "  - Implemented JWT-based authentication"
    echo "  - Added login/logout endpoints"
    echo "  - Created user session management"
    echo ""
    echo "  ## Why"
    echo "  - Users need to securely access their data"
    echo "  - Required for Phase 2 features (DEC-003)"
    echo ""
    echo "  ## Files Changed"
    echo "  - src/auth/jwt.py: JWT token handling"
    echo "  - src/api/auth.py: Login/logout endpoints"
    echo "  - memory/NOW.md: Updated current status"
    echo ""
    exit 1
fi

echo -e "${GREEN}[OK]${NC} Commit message validated"
echo ""

exit 0
